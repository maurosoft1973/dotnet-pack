name: .NET Pack
description: An opinionated action that retrieve previously build projects and packs them into a NuGet package.
inputs:
  configuration:
    description: Defines the build configuration. Default is Release.
    required: true
    default: 'Release'
  packageName:
    description: Defines the name of the nuget package (the complete name is packageName.version).
    required: true
    default: 'package'
  level:
    description: Sets the verbosity level of the command. Allowed values are q[uiet], m[inimal], n[ormal], d[etailed], and diag[nostic]. The default is quiet.
    required: true
    default: 'quiet'
  uploadPackedArtifact:
    description: Upload the created NuGet packages. Default is to not upload.
    required: false
    default: 'false'
  version:
    description: The version of your project, e.g. 1.0.0.
    required: true
  restoreCacheKey:
    description: When set, current workspace will be overwritten with the content of the restore cache. Default is empty.
    required: false
    default: ''
  retentionDaysArtifact:
    description: Duration after which artifact will expire in days.Default is 1.
    required: false
    default: 1
runs:
  using: composite
  steps:
    - if: inputs.restoreCacheKey != ''
      name: Restore
      uses: actions/cache/restore@v4
      with:
        path: |
          ${{ github.workspace }}
          !${{ github.workspace }}/.git
          ~/.nuget/packages
        key: ${{ inputs.restoreCacheKey }}
        restore-keys: |
          dotnet-restore-
        enableCrossOsArchive: true
        fail-on-cache-miss: true

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '*-${{ inputs.configuration }}'
        merge-multiple: true

    - name: Set Version
      run: |
        echo "MINVERVERSIONOVERRIDE=${{ inputs.version }}" >> $GITHUB_ENV
      shell: bash

    - if: inputs.restoreCacheKey == ''
      name: Pack (Pre-requisite)
      uses: codebeltnet/dotnet-restore@v2

    - name: Pack
      run: |
        dotnet pack -p:PackageID=${{ inputs.packageName }} -p:Version=${{ inputs.version }} --configuration ${{ inputs.configuration }} --verbosity ${{ inputs.level }} --no-build --output ${{ runner.temp }}/.nuget ${{ inputs.project }}
      shell: bash

    - if: inputs.uploadPackedArtifact == 'true'
      name: Upload NuGet Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.packageName }}.${{ inputs.configuration }}.${{ inputs.version }}.nupkg
        path: ${{ runner.temp }}/.nuget/${{ inputs.packageName }}.${{ inputs.version }}.nupkg
        if-no-files-found: error
        include-hidden-files: true
        retention-days: ${{ inputs.retentionDaysArtifact }}
branding:
  icon: 'umbrella'
  color: 'blue'
